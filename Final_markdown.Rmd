---
title: "Predicting Tardy Trains on NJ Transit"
author: "Jonathon Sun & Johnathan Clementi"
date: "12/17/2021"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    code_folding: hide
---
<style type="text/css">

h1.title {
  text-align: center;
}
h4.author { /* Header 4 - and the author and data headers use this too  */
  text-align: center;
}
h4.date { /* Header 4 - and the author and data headers use this too  */
  text-align: center;
}
</style>

```{r setup, message=FALSE, warning=FALSE, include = FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	echo = FALSE,
	error = FALSE,
	cache = TRUE
)
pacman::p_load(tidyverse, vroom, DataExplorer, lubridate, sf, tidycensus, tigris, hms, riem, slider, scales, caret,RcppEigen, ckanr, FNN, ggcorplot, grid, gridExtra, gtools, httr, kableExtra, modelsummary,tidycensus, spdep, stargazer, tmap, viridis, zipcodeR, DT, dplyr, scales, ggthemes, plotly, gganimate, stringr, rstudioapi)


library(ggcorrplot)

#RcppEigen https://rdrr.io/cran/RcppEigen/ runs fastLm()

options(scipen = 100)

root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

palette_9_colors <- c("#FF2AD4","#E53AD8","#CC4ADC","#996AE5","#7F7BE9",
                      "#668BED","#33ABF6","#19BBFA","#00CCFF")
palette_3_colors <- c("#FF2AD4","#7F7BE9","#00CCFF")
palette_2_colors <- c("#FF2AD4", "#00CCFF")
palette_1_colors <- c("#00CCFF")

currentDir <- str_replace(getSourceEditorContext()$path, "Final_markdown.Rmd", "")
headingImg <- paste0(currentDir, "njTransit_coverimage.jpg")
```
![Passengers wait to board an arriving NJ Transit Train](`r headingImg`)

# Introduction and Motivation



Although train delays may seem like minor annoyances in the daily life of a commuter, there are real economic costs to train tardiness. The city of New York Office of the Controller found that major delays (5-minute delays) annually cost the city \$170.2 million dollars (Stringer, 2017). While some systems are truer to their timetables, systems like Amtrak are notoriously late (Lazo, 2019). In the case of Amtrak, a primary driver of lateness is congestion as it does not own most of the right of way it operates on. In a 2019 report detailing its on-time-performance (OTP) woes, Amtrak estimated approximately \$171 million in losses during 2018 due to 27% of their trains being late (Amtrak, 2019).

OTP issues are not exclusive to Amtrak in the Northeast. Regional operators such as the NJ Transit have a history of delays (McGeehan, 2018). In this study, we build and test a linear regression to predict delay length for trains based on a variety of predictors. The hope is that this model can be utilized by agencies, researchers, and the average commuter.

For agencies and researchers, the visualizations and algorithm can be a tool to identify bottlenecks in the system. Whether that be the stations that are coming from or arriving to or if there is a particular day of the week that is most late. This analysis will lead to the identification of lateness so that it can be addressed. For the average commuter, this analysis can provide a way to determine average lateness and given a set of variables; how late will the train be?

# Data

```{r trainTimes, message=FALSE, warning=FALSE}
import <- paste0("Amtrak/",list.files("Amtrak"))

df <- data.frame()

############ TO RUN FULL MODEL, UNCOMMENT THIS CODE ############
# for (i in 2:nrow(as_tibble(import))) {
#   df <- rbind(df,read.csv(import[i]))
# }
############ TO RUN FULL MODEL, UNCOMMENT THIS CODE ############

############ TO RUN SAFE MODEL, UNCOMMENT THIS CODE ############
for (i in 2:nrow(as_tibble(import))) {
  if(grepl("2020",import[i])){
      df <- rbind(df,read.csv(import[i]))
  } else {
    # print(paste(import[i], "not added"))
  }

}
############ TO RUN SAFE MODEL, UNCOMMENT THIS CODE ############

# Stations There's no complete set of NJ transit lines anymore ---------------------------

NJTransitLines <- bind_rows(st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_13.geojson"),
                            st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_9.geojson"),
                            st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_3.geojson"),
                            st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_4.geojson"),
                            st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_1.geojson"),
                            st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_5.geojson"),
                            st_read("https://opendata.arcgis.com/datasets/fc24118ac4a0445da5e09f7692075757_0.geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/2/query?outFields=*&where=1%3D1&f=geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/6/query?outFields=*&where=1%3D1&f=geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/7/query?outFields=*&where=1%3D1&f=geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/8/query?outFields=*&where=1%3D1&f=geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/10/query?outFields=*&where=1%3D1&f=geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/11/query?outFields=*&where=1%3D1&f=geojson"),
                            st_read("https://services6.arcgis.com/M0t0HPE53pFK525U/arcgis/rest/services/NJTransit_Rail_Linea/FeatureServer/12/query?outFields=*&where=1%3D1&f=geojson")) %>%
  select(!c("OBJECTID","LINE_CODE"))



NJtransitstations <- st_read("https://opendata.arcgis.com/datasets/4809dada94c542e0beff00600ee930f6_0.geojson") 

NJshp <- tigris::states() %>%
             filter(NAME == "New Jersey")

df <- df %>%
  filter(type == "NJ Transit") %>%
  mutate(date = ymd(date),
         scheduled_time = ymd_hms(scheduled_time),
         actual_time = ymd_hms(actual_time),
         week = week(date),
         DotW = wday(date),
         Start_time = as_hms(scheduled_time),
         Actual_time = as_hms(actual_time),
         AM_PM = ifelse(am(Actual_time) == TRUE, "AM","PM"),
         Year = year(date),
         # Code below used to get the lag of the station previous in station sequence
         # Get train id of previous row
         train_lag = lag(train_id),
         # Find the delay at that station
         time_lag_dumb = lag(delay_minutes),
         # Check if current stop is on the same train as the previous stop
         train_end = train_lag == train_id,
         # If we're still on the same train, remove time_lag
         station_lag = ifelse(train_end == TRUE, time_lag_dumb,NA),
         accumulated_delay = delay_minutes + station_lag,
         quintile_delay = q5(delay_minutes),
         ID = row_number()) %>%
  mutate(scheduled_TOD = case_when(hour(scheduled_time) < 7 | hour(scheduled_time) > 18 ~ "Overnight",
                                 hour(scheduled_time) >= 7 & hour(scheduled_time) < 10 ~ "AM Rush",
                                 hour(scheduled_time) >= 10 & hour(scheduled_time) < 15 ~ "Mid-Day",
                                 hour(scheduled_time) >= 15 & hour(scheduled_time) <= 18 ~ "PM Rush")) %>%
  select(!c("time_lag_dumb","train_end","train_lag")) %>%
  rename(scheduled_datetime = scheduled_time,
         actual_datetime = actual_time) 
# %>%
#   mutate(station_link = paste(from, to, sep = "-"))


Analysis_Dates <- seq(min(as.Date(df$date)), max(as.Date(df$date)), by="days")
Analysis_Dates <- as.tibble(Analysis_Dates) %>%
                  mutate(day = row_number()) %>%
                  rename(date = value)

df <- left_join(df,Analysis_Dates, by = "date")

# Weather -------------------------------------

#df %>%
#  filter(line %in% c("Amtrak","AMTRAK","AMTRAK REGIONAL")) %>%
#  View()

#f <- df %>%
#      mutate(merge = case_when(from == "New York Penn Station" & to == "New York Penn Station" & line == "Amtrak" ~ "Winner",
#                               from == "Philadelphia" & to == "New York Penn Station" & line == "Amtrak" ~ "Something",
#                               from == "New York Penn Station" & to == "Philadelphia" & line == "Amtrak" ~ "Apple"))


weather.Panel <- 
  riem_measures(station = "EWR", date_start = (as.Date(min(df$date))-5), date_end = (as.Date(max(df$date))+5)) %>%
  dplyr::select(valid, tmpf, p01i, sknt)%>%
  replace(is.na(.), 0) %>%
    mutate(interval60 = ymd_h(substr(valid,1,13))) %>%
    mutate(week = week(interval60),
           dotw = wday(interval60, label=TRUE)) %>%
    group_by(interval60) %>%
    summarize(Temperature = max(tmpf),
              Precipitation = sum(p01i),
              Wind_Speed = max(sknt)) %>%
    mutate(Temperature = ifelse(Temperature == 0, 42, Temperature))

df <- left_join(df %>% mutate(interval60 = floor_date(actual_datetime, unit = "hour")), weather.Panel, by = "interval60")

#Attaching Geography -----------------------------------

df <- df %>%
              mutate(clean = ifelse(is.na(Start_time) == TRUE, "remove","keep")) %>%
              filter(clean == "keep") %>%
              select(!clean) %>% 
              mutate(LINE_NAME = case_when(line == "Atl. City Line" ~ "Atlantic City Line",
                                           line == "Bergen Co. Line " ~ "Bergen County Line", 
                                           # Be careful about the space at the end the Bergen Co. Line - was causing missing vals
                                           line == "Gladstone Branch" ~ "Gladstone Branch",
                                           line == "Main Line" ~ "Main Line",
                                           line == "Montclair-Boonton" ~ "Montclair-Boonton Line",
                                           line == "Morristown Line" ~ "Morristown Line",
                                           line == "No Jersey Coast" ~ "NJ Coast Line",
                                           line == "Northeast Corrdr" ~ "Northeast Corridor",
                                           line == "Pascack Valley" ~ "Pascack Valley Line",
                                           line == "Princeton Shuttle" ~ "Princeton Dinky",
                                           line == "Raritan Valley" ~ "Raritan Valley Line")) 

df_shp <- left_join(df, NJTransitLines, by = "LINE_NAME") %>%
            st_as_sf()

# Cleaning Geometry ----------------------------------

NJtransitstations[149,2] <- "Middletown NY"
NJtransitstations$STATION_ID <- trimws(NJtransitstations$STATION_ID)

Station_clean <- df_shp %>%
                   st_drop_geometry() %>%
                   select(from) %>%
                   arrange(from) %>%
                   unique() %>%
                   mutate(Spelled_correctly = ifelse(from %in% NJtransitstations$STATION_ID, TRUE, FALSE)) %>%
                   filter(Spelled_correctly == FALSE)


f <- c("Anderson Street-Hackensack",
       "Atlantic City",
       "Bay Street-Montclair",
       "Broadway",
       "Essex Street-Hackensack",
       "Glen Rock-Boro Hall",
       "Glen Rock-Main",
       "Hoboken Terminal",
       "Middletown",
       "Montclair St Univ",
       "Mt Arlington",
       "Mountain Station",
       "Pennsauken Transit Center",
       "30th Street Station",
       "Princeton Jct.",
       "Radburn",
       "Ramsey",
       "Rte 17 Ramsey",
       "Secaucus Junction Upper Level",
       "Secaucus Junction Lower Level",
       "Secaucus Junction Upper Level",
       "Teterboro-Williams Ave",
       "Watsessing",
       "Wayne Route 23 Transit Center",
       "Wood-Ridge")

Station_clean <- bind_cols(Station_clean,f) %>%
                  rename(clean_name = ...3)

for(i in 1:nrow(Station_clean)) {
df_shp$from <- str_replace(df_shp$from, Station_clean$from[i],Station_clean$clean_name[i])
df_shp$to <- str_replace(df_shp$to, Station_clean$from[i],Station_clean$clean_name[i])
}
```

```{r message=FALSE, warning=FALSE}
remove <- c("ID","from_id","to_id","train_id","type","interval60","line","date","scheduled_datetime",
            "actual_datetime","Actual_time","accumulated_delay", "quintile_delay", "AM_PM", "status")


ColNamesClean <- as.tibble(colnames(df %>%
                                      select(!remove))) %>%
                    rename(Name = value) %>%
                    mutate(Name = str_to_title(Name),
                           Name = str_replace(Name,"_"," "))
datatable(df_shp %>%
       st_drop_geometry() %>%
       select(!remove) %>%
       sample_n(500),
     class = 'cell-border stripe',
     rownames = FALSE,
     colnames = ColNamesClean$Name,
     # caption = "Table 1: Table view of the data",
     filter = 'bottom',
     # extensions = 'FixedColumns',
     options = list(dom = 't',
                    scrollX = TRUE,
                    fixedColumns = TRUE,
                    pageLength = 10))


```
Table 1 includes a sample of 500 rows to view the data. Use the filter boxes at the bottom of the table window to filter, select, and order the data.

This model uses data from Kaggle on Amtrak and NJ Transit, shapefile data from ESRI, and weather data from `riem`. For the data from kaggle we used data specifically from NJ Transit. The NJ Transit is the public transit system for the state of New Jersey and includes buses, trains, and light rail; however, for this study we are only finding delays for trains. The NJ Transit has `r length(unique(df$line))` different train lines and `r length(unique(df$from))` stations. The dataset that we have selected comprises of `r nrow(df)` and `r length(colnames(df))` variables. From this dataset, we engineered a number of other variables such as station lag, the delay at the previous station, and the accumulated delay at each stop sequence. In addition to the train data, we also included data on the weather, at the time of the train departing. Weather data was pulled from the nearest station which was Newark International Airport.

The station lag is the magnitude by which a train is late at the station previous to the current station for a given train on a single route. Said differently, if train 123 travels from stations A -> B -> C, and is late by 2 minutes at station B, then the station lag for train 123 at station C is 2 minutes. This feature introduces the ability to account for delays at the previous station as a predictor for how late train will be to the current station. As seen later in the exploratory analyses, delays accumulate as trains get closer to their destination. The spatiotemporal process of accumulated delay is an important predictor of a train's lateness to a station.


# Exploratory Analyses

To conceptualize what variables to consider in the model, we explored the data through plot correlations, categorical data, delays by time, delays by station, geography and delays over time. The purpose of these exploratory analyses is to gain a better understanding for the story of lateness. We answer questions such as 'which lines experience more lateness than others', 'during which times of day is lateness more prevalent in the system', and 'which stops in a line seem to cause more delay compared to other stops?' By first examining these trends, we gain a better understanding of the drivers of lateness in NJ Transit's system.

## Correlation Identification

To explore the correlation in data, we used the `DataExplorer` package's `plot_correlation()` function. This package also plots correlation of categorical data by breaking categorical data into dummy variables. The plot below shows the relationship between all the variables.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.height= 10}
DataExplorer::plot_correlation(df %>% select(!line))
```

## Categorical Predictors

To better understand the relationships in categorical data, in the plot below the average delay was plotted for AM/PM, line, scheduled time of day, and status of the train. The plot does indicate that There is not a large difference between trains based on AM/PM; however, there are differences in delay based on the line.

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10}
Categorical <- df_shp %>%
                st_drop_geometry() %>%
                na.omit() %>%
                select(where(is.character),delay_minutes)

#colnames(Categorical)

cat <- Categorical %>%
        select(colnames(Categorical)[2], delay_minutes) %>%
        mutate(Variable = colnames(Categorical[2])) %>%
        dplyr::rename("Value" = 1)

for(i in 2:(nrow(as.tibble(colnames(Categorical)))-1)) {
t <- Categorical %>%
        select(colnames(Categorical)[i], delay_minutes) %>%
        mutate(Variable = colnames(Categorical[i])) %>%
        dplyr::rename("Value" = 1)

cat <- bind_rows(cat,t)
}

ggplot(data = cat %>%
         filter(!Variable %in% c("from","to","train_id","type","line")),
       aes(x = Value,  y = delay_minutes)) +
  geom_bar(stat = "summary", fun.y = "mean") +
  scale_y_continuous(labels = comma) +
  facet_wrap(~Variable, scales = "free") +
  plotTheme() +
  labs(x = "Categorical Variables",
       y = "Delay in Minutes",
       title = "Cateogrical Variables Average Delay")

#ggsave("Categorical_Variables.jpg", width = 16, height = 9, unit = "in", dpi = 300)
```

## Delays By Time: Hour of Day

Next we wanted to understand the relationship of lateness over the course of 24 hours. First we categorized the scheduled trains by AM Rush, Mid-Day, PM Rush, and Overnight, and then counted the frequencies of trains that were more than 5 minutes late during each of these periods. Next the overall line delays in the dataset were counted and plotted against the hour in the day. This shows at what time of day how many trains were late.

```{r echo=TRUE, fig.width=10, message=FALSE, warning=FALSE}
# A <-
df %>%
  mutate(delay_grtr5min = case_when(delay_minutes >= 5 ~ 1,
                                    delay_minutes < 5 ~ 0)) %>%
  filter(delay_grtr5min == 1) %>%
  group_by(interval60, scheduled_TOD, LINE_NAME) %>%
    tally() %>%
  summarize(avg_trainsLate = mean(n)) %>%
  ggplot() +
    geom_histogram(aes(x = avg_trainsLate), binwidth = 1) +
    facet_wrap(~factor(scheduled_TOD,levels=c("AM Rush", "Mid-Day", "PM Rush", "Overnight"))) +
  plotTheme() +
  labs(title = "Delays by Time of Day",
       x = "Number of Trains Late",
       caption = "Figure X")

# B <-
df %>%
  mutate(delay_grtr5min = case_when(delay_minutes >= 5 ~ 1,
                                    delay_minutes < 5 ~ 0)) %>%
  filter(delay_grtr5min == 1) %>%
  group_by(interval60) %>%
  ggplot() +
    geom_freqpoly(aes(hour(scheduled_datetime), color = LINE_NAME), size = 1, binwidth = 1) +
  facet_wrap(~LINE_NAME) +
  plotTheme() +
  labs(title = "Count of Lateness by Line by Time",
       x = "Scheduled Hour of Day",
       caption = "Figure X")

# grid.arrange(A,B, ncol = 2, nrow=1, widths = c(1.5,2),
#              top = textGrob("Plots showing Usage Over Time", gp=gpar(fontsize=20,font=3)))

```

## Delays over Time: Days of the Year

Next we analyzed day within the time of the year, rather than hours within a day. Figure X shows the amount of delay over the course of a year by day. The dotted line in the figure indicates the first day covid-19 was detected in the United States. Based on the data, it is difficult to determine the role that covid-19 had on average delay times. To better understand the role of covid-19, data from year prior to covid will need to be used in a t-test.

### By Line Name

```{r message=FALSE, warning=FALSE}
#df %>%
#  filter(date == as.numeric(ymd(c("2020-01-20"))))

covid_day <- 691 # for full dataset
covid_day <- 20

animate(
  df_shp %>%
  st_drop_geometry() %>%
  group_by(day,LINE_NAME) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  na.omit() %>%
  ggplot(aes(x = day, y = mean_delay, color = LINE_NAME)) +
  geom_line(se = FALSE) +
  geom_vline(xintercept = covid_day, linetype = "dashed") +
  labs(title = "Average Delay Over Time",
       subtitle = "By Line",
       y = "Average Delay",
       x = "Day") +
  plotTheme() +
  theme(legend.position = "hide") +
  facet_wrap(~LINE_NAME)+
  transition_reveal(day), 
  width = 800, height = 800)

#anim_save(filename = "LINE_NAME.gif",animation = last_animation())
```

In addition to the animated plots, Figure X also includes average delays that has been smoothed using `geom_smooth` rather than `geom_line`. `geom_smooth` estimates a best fit line rather than directly plotting and following every single point.

```{r message=FALSE, warning=FALSE}
ggplotly(df_shp %>%
  st_drop_geometry() %>%
  group_by(date,LINE_NAME) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  ggplot(aes(x = date, y = mean_delay, color = LINE_NAME)) +
  geom_smooth(se = FALSE) +
  geom_vline(xintercept = as.numeric(ymd(c("2020-01-20"))), linetype = "dashed") +
  labs(title = "Average Delay by Day of Year",
       subtitle = "By Line",
       y = "Average Delay",
       x = "Date",
       caption = "Figure X") +
  plotTheme())

#ggsave("smooth_line_delay.jpg", width = 16, height = 9, unit = "in", dpi = 300)
```

### By Stop Sequence

Finally, figure X, includes an estimated line for delays by stop sequence. Stop sequence indicates where on the line this train has stopped; for example, the North East Corridor may have multiple stops and those stops are organized by values 1, 2, 3, and so forth.This figure is particularly interesting because it shows that delays accumulate in the system. Most trains at the beginning of their route leave on time, whereas as trains experience delays further into their route.

```{r message=FALSE, warning=FALSE}
factor_order <- c(1:26)

animate(df_shp %>%
  st_drop_geometry() %>%
  group_by(day,stop_sequence) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  mutate(stop_sequence = factor(stop_sequence, levels = factor_order)) %>% 
  ggplot(aes(x = day, y = mean_delay, color = stop_sequence)) +
  geom_line(se = FALSE) +
  geom_vline(xintercept = covid_day, linetype = "dashed") +
  labs(title = "Average Delay by Day of Year",
       subtitle = "By Line",
       y = "Average Delay",
       x = "Day") +
  plotTheme() +
  facet_wrap(~stop_sequence) +
  theme(legend.position = "hide",
        axis.ticks.x = element_blank()) +
  transition_reveal(day), 
  width = 800, height = 800)

#anim_save(filename = "stop_sequence.gif",animation = last_animation())
```

Similarly to the analysis by Line Name, figure x below is a smoothed out using `geom_smooth` rather than `geom_line`

```{r message=FALSE, warning=FALSE}
ggplotly(df_shp %>%
  st_drop_geometry() %>%
  group_by(date,stop_sequence) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  mutate(stop_sequence = factor(stop_sequence, levels = factor_order)) %>% 
  ggplot(aes(x = date, y = mean_delay, color = stop_sequence)) +
  geom_smooth(se = FALSE) +
  geom_vline(xintercept = as.numeric(ymd(c("2020-01-20"))), linetype = "dashed") +
  labs(title = "Average Delay Over Time",
       subtitle = "By Stop Sequence",
       y = "Average Delay",
       x = "Date",
       caption = "Figure X") +
  plotTheme())

#ggsave("smooth_Stop_delay.jpg", width = 16, height = 9, unit = "in", dpi = 300)
```

## Station delays

Rather than just analyze delays by time of day, we also wanted to understand the role that stations had in delay times for trains. Below we included a plot that shows the average delay to and from a station. This figure is particularly useful for agencies as it allows for the identification of specific stations that are causing and being a recipient of delays in the system.

```{r fig.height=12, fig.width=10, message=FALSE, warning=FALSE}
ggplotly(ggplot(data = cat %>%
         filter(Variable %in% c("from","to")) %>%
         arrange(Value) %>%
         mutate(Value = as.factor(Value)),
       aes(x = Value,  y = delay_minutes, fill = Variable)) +
  geom_bar(position = "dodge2", stat = "summary", fun.y = "mean") +
  scale_y_continuous(labels = comma) +
  plotTheme() +
  labs(x = "Station Names",
       y = "Delay in Minutes",
       title = "Cateogrical Variables Average Delay",
       caption = "Figure X") +
  theme(axis.title.x = element_blank()) +
  coord_flip())

#ggsave("Station_Delay.jpg", width = 16*1.5, height = 9*1.5, unit = "in", dpi = 300)
```

### Station Delays by Geography

In addition to analysis on Time, this study also includes space. The maps below of the NJ transit lines show the average delow going to and from each station on the NJ Transit. As illustrated below, the average train on the Atlantic City Line is around 15 minutes late.

```{r}
A <- df_shp %>%
  st_drop_geometry() %>%
  group_by(from) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  mutate(Bin_mean_delay = cut_interval(mean_delay, n = 20, dig.lab = 10))

A <- length(unique(A$Bin_mean_delay))

cc <- scales::seq_gradient_pal("Red","Grey")(seq(0,1,length.out=A))

#df_shp %>%
#  st_drop_geometry() %>%
#  group_by(from) %>%
#  summarize(mean_delay = mean(delay_minutes)) %>%
#  mutate(Bin_mean_delay = cut_interval(mean_delay, n = 20, dig.lab = 10),
#         Bin_mean_delay = str_remove(Bin_mean_delay,"."),
#         Bin_mean_delay = str_sub(Bin_mean_delay,1,nchar(Bin_mean_delay)-1)) %>%
#  separate(Bin_mean_delay, into = c("Start","End"), sep = ",") %>%
#  mutate(Start = round(as.numeric(Start),3),
#         End = round(as.numeric(End),3)) %>%
#  arrange(Start) %>%
#  mutate(Start = as.character(Start),
#         End = as.character(End),
#         Interval = paste0(Start," - ",End),
#         Interval = forcats::as_factor(Interval)) %>%
#  rename(STATION_ID = from) %>%
#  left_join(NJtransitstations, by = "STATION_ID") %>%
#  st_as_sf() %>%
#  ggplot() +
#  geom_sf(data = NJTransitLines) +
#  geom_sf(aes(color = Interval)) +
#  geom_sf(data = NJshp, fill = "transparent") +
#  scale_color_manual(values = cc) +
#  labs(title = "Delay in minutes going from a Station") +
#  mapTheme()


B <- df_shp %>%
  st_drop_geometry() %>%
  group_by(from) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  rename(STATION_ID = from) %>%
  left_join(NJtransitstations, by = "STATION_ID") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = NJTransitLines) +
  geom_sf(aes(color = mean_delay)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "From a Station") +
  scale_color_gradient(low = "green",
                       high = "red") +
  theme(legend.position = "bottom") +
  mapTheme()


#ggsave("Delay_from_station.jpg", width = 16, height = 9, unit = "in", dpi = 300)

A <- df_shp %>%
  st_drop_geometry() %>%
  group_by(to) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  mutate(Bin_mean_delay = cut_interval(mean_delay, n = 20, dig.lab = 10))

A <- length(unique(A$Bin_mean_delay))

cc <- scales::seq_gradient_pal("Red","Grey")(seq(0,1,length.out=A))

#df_shp %>%
#  st_drop_geometry() %>%
#  group_by(to) %>%
#  summarize(mean_delay = mean(delay_minutes)) %>%
#  mutate(Bin_mean_delay = cut_interval(mean_delay, n = 20, dig.lab = 10),
#         Bin_mean_delay = str_remove(Bin_mean_delay,"."),
#         Bin_mean_delay = str_sub(Bin_mean_delay,1,nchar(Bin_mean_delay)-1)) %>%
#  separate(Bin_mean_delay, into = c("Start","End"), sep = ",") %>%
#  mutate(Start = as.numeric(Start)) %>%
#  arrange(Start) %>%
#  mutate(Start = as.character(Start),
#         Interval = paste0(Start," - ",End),
#         Interval = forcats::as_factor(Interval)) %>%
#  rename(STATION_ID = to) %>%
#  left_join(NJtransitstations, by = "STATION_ID") %>%
#  st_as_sf() %>%
#  ggplot() +
#  geom_sf(data = NJTransitLines) +
#  geom_sf(aes(color = Interval)) +
#  geom_sf(data = NJshp, fill = "transparent") +
#  scale_color_manual(values = cc) +
#  labs(title = "Delay in minutes going to a Station") +
#  mapTheme()

#ggsave("Delay_to_station.jpg", width = 16*.5, height = 9*.5, unit = "in", dpi = 300)


C <- df_shp %>%
  st_drop_geometry() %>%
  group_by(to) %>%
  summarize(mean_delay = mean(delay_minutes)) %>%
  rename(STATION_ID = to) %>%
  left_join(NJtransitstations, by = "STATION_ID") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = NJTransitLines) +
  geom_sf(aes(color = mean_delay)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "To a Station") +
  scale_color_gradient(low = "green",
                       high = "red") +
  theme(legend.position = "bottom") +
  mapTheme()
  

#ggsave("Delay_to_station.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)

grid.arrange(C,B, ncol = 2, nrow=1,
             top = textGrob("Average Delay To and From Station", gp=gpar(fontsize=20,font=3)))
```

# Model building

```{r message=FALSE, warning=FALSE, include=FALSE}
set.seed(111)

#sample_size = round(nrow(df_shp %>%
#                           st_drop_geometry())*.6)
#trainIndex <- sample(seq_len(nrow(df_shp %>%
#                           st_drop_geometry())), size = sample_size)

#Train <- lmdf[trainIndex,]
#Valid <- lmdf[-trainIndex,]


remove <- c("ID","from_id","to_id","train_id","type","interval60","line","date","scheduled_datetime",
            "actual_datetime","Actual_time","accumulated_delay", "quintile_delay", "AM_PM", "status")

Sample <- df %>%
          select(!remove) %>%
          # Filter out Princeton Dinky because it didn't run during parts of pandemic
          filter(LINE_NAME != "Princeton Dinky")

Train <- filter(Sample, (week >= 1) & (week <= 15))

Test <- filter(Sample, (week >= 16))

# Test <- df %>%
#           select(!remove) %>%
#           filter(!ID %in% Sample$ID) %>%
#           filter(from %in% Sample$from) %>%
#           filter(to %in% Sample$to) %>%
#           filter(LINE_NAME %in% Sample$LINE_NAME) %>%
#           na.omit() 

#to test use slice()
# 
# Train <- Train %>%
#             select(!ID)
# 
# Test <- Test %>%
#           select(!ID)

# Garbage Collector!!
gc()
```


After exploring the data, we built a linear model that includes **`r colnames(Sample)`**. Compared to a model that includes all the variables, this model is more advantageous because it avoids the problem of being overfit. When a model was built that included all the variables, the model had an R\^2 value of 1 and 0 Mean Squared Error (MSE). The current model includes an MSE not equal to 0 and a R\^2 value less than 1, which means the model is not overfit, and can predict on new data.   

Once we identified the suitable predictors for the model, the data were then subsetted into training and test datasets. The training set are the data on which the model is built and consists of `r max(Train$week) - min(Train$week)` weeks of the original dataset. The model is then evaluated to determine its effectiveness using the test set consisting of the `r max(Test$week) - min(Test$week)` weeks that follow the training set.   

The table below contains model summary and coefficients and corresponding p-values for our model. 

```{r runmodels, message=FALSE, warning=FALSE, cache=FALSE, echo=FALSE, results='asis'}
#reg.training <- fastLm(delay_minutes ~ ., data = Train)

reg.training <- lm(delay_minutes ~ ., data = Train)

#summary(reg.training) Our R squared is 1. Definitely an overfit model. We'll see how well it predicts though. 

f <- predict(reg.training, Test)

Test <- bind_cols(Test, as.tibble(f)) %>%
          rename(Delay.Predict = value) %>%
          mutate(Delay.Error = Delay.Predict - delay_minutes,
               Delay.AbsError = abs(Delay.Predict - delay_minutes),
               Delay.APE = (abs(Delay.Predict - delay_minutes)) / Delay.Predict)


mae <- mean(Test$Delay.AbsError, na.rm=TRUE)
#print(mae)
mape <- mean(Test$Delay.APE, na.rm=TRUE)
#print(mape)


# Table of regression outputs
#modelsummary(reg.training, output = "kableExtra", stars = TRUE, gof_omit = 'IC|Log|AIC|BIC')
stargazer(reg.training, type="html", header = TRUE, align=TRUE,
          single.row = TRUE, style = "apsr",
          notes.append = FALSE,
          notes = c("<sup>&sstarf;</sup>p<0.1; <sup>&sstarf;&sstarf;</sup>p<0.05; <sup>&sstarf;&sstarf;&sstarf;</sup>p<0.01"))

```

Based on the linear regression we found the Mean Absolute Error (MAE) to be `r print(mae)` and the Mean Absolute Percent Error (MAPE) to be `r print(mape)`. These 'goodness of fit' metrics are used to measure how closely the model can predict the delays of trains in the test dataset. The MAE can be interpreted as the average number of minutes that the model over or under predicts compared to the actual delay at each stop. If our minimum delay time is 0, and maximum delay time is `r print(max(Sample$delay_minutes))`, then an MAE of `r print(mae)` is actually pretty good. Further, the MAPE is interpreted as the percentage of trains that the model predicted incorrectly.   

# Cross Validation

To ensure build a robust model, we utilized the K-fold cross-validation technique to repeat the modeling process detailed above. In essence, cross-validation process involves partitioning the dataset into *K* number groups (otherwise known as folds). For each fold, the modeling process described above is repeated - split into training/test sets, build model on training, calculate goodness of fit metrics for test set. The repetition of the modeling process allows us to simulate how our model would perform on unseen data in a real world setting. 

```{r Cross_Validation, message=FALSE, warning=FALSE}
fitControl <- trainControl(method = "cv", number = 5)
set.seed(825)

reg.cv <- 
  train(delay_minutes ~ ., data = Train, 
     method = "lm", trControl = fitControl, na.action = na.pass)

reg.cv
```

The results of our cross-validation indicate that the model is an effective method for predicting NJ Transit train lateness. The RMSE value of `r mean(reg.cv$resample$RMSE)` indicates that on average, the model either over-predicts or under-predicts lateness by about 2 minutes. Additionally, the R\^2 value of `r mean(reg.cv$resample$Rsquared)` indicates that the model may have some over fit. However, these values only give impressions about the model as a whole. To identify stations for which the model is better or worse at predicting, we must visualize the errors geographically.

### Average Predictions

#### Average Predicted Delay by Train Route

First we wanted to visualize the average predicted delay times by geography. Figure X includes the predicted delay by line. Similar to Figure X, the predicted delays are very similarly spread out geographically.

```{r}

Test %>%
  na.omit() %>%
  group_by(LINE_NAME) %>%
  summarize(Mean_Delay = mean(Delay.Predict)) %>%
  left_join(NJTransitLines, by = "LINE_NAME") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(aes(color = Mean_Delay,
              linetype = LINE_NAME)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "Estimated Delay by Line",
       caption = "Figure X") +
  scale_color_gradient(low = "green",
                       high = "red") +
  mapTheme()

ggsave("Modeled_Delay_Line.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)
```

#### Predicted Delay To and From Station

Additionally, we've included the predicted delay TO and From each station by geographic location.

```{r}
B <- Test %>%
  group_by(from) %>%
  summarize(Mean_Delay = mean(Delay.Predict)) %>%
  rename(STATION_ID = from) %>%
  left_join(NJtransitstations %>%
              select(STATION_ID,LATITUDE,LONGITUDE,geometry), by = "STATION_ID") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = NJTransitLines) +
  geom_sf(aes(color = Mean_Delay)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "From",
       x = "Predicted Mean Delay") +
  scale_color_gradient(low = "green",
                       high = "red") +
  theme(legend.position = "bottom") +
  mapTheme()

ggsave("Modeled_Delay_from_station.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)


C <- Test %>%
  group_by(to) %>%
  summarize(Mean_Delay = mean(Delay.Predict)) %>%
  rename(STATION_ID = to) %>%
  left_join(NJtransitstations %>%
              select(STATION_ID,LATITUDE,LONGITUDE,geometry), by = "STATION_ID") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = NJTransitLines) +
  geom_sf(aes(color = Mean_Delay)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "To",
       x = "Predicted Mean Delay") +
  scale_color_gradient(low = "green",
                       high = "red") +
  theme(legend.position = "bottom") +
  mapTheme()


ggsave("Modeled_Delay_to_station.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)

grid.arrange(C,B, ncol = 2, nrow=1,
             top = textGrob("Average Predicted Delay To and From Station", gp=gpar(fontsize=20,font=3)))
```

### Average Errors in Predictions

Although the model accounts for most error, we wanted to check how the well the model accounts for differences in geography. It is clear that while the model is good a predicting values close to the average delay, it loses predictive power for the Atlantic City Line with is consistently more late than the other NJ Transit lines.   

#### Average Errors in Predicted Delay by Train Route

```{r}

Test %>%
  na.omit() %>%
  group_by(LINE_NAME) %>%
  summarize(Mean_AbsError = mean(Delay.AbsError)) %>%
  left_join(NJTransitLines, by = "LINE_NAME") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(aes(color = Mean_AbsError,
              linetype = LINE_NAME)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "Estimated Delay by Line") +
  scale_color_gradient(low = "green",
                       high = "red") +
  mapTheme()

ggsave("Modeled_Delay_Line.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)
```

#### Average Errors in Predicted Delay To and From Station

```{r}
B <- Test %>%
  group_by(from) %>%
  summarize(Mean_AbsError = mean(Delay.AbsError)) %>%
  rename(STATION_ID = from) %>%
  left_join(NJtransitstations %>%
              select(STATION_ID,LATITUDE,LONGITUDE,geometry), by = "STATION_ID") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = NJTransitLines) +
  geom_sf(aes(color = Mean_AbsError)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "From",
       x = "Predicted Mean Delay") +
  scale_color_gradient(low = "green",
                       high = "red") +
  theme(legend.position = "bottom") +
  mapTheme()

ggsave("Modeled_Delay_from_station.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)


C <- Test %>%
  group_by(to) %>%
  summarize(Mean_AbsError = mean(Delay.AbsError)) %>%
  rename(STATION_ID = to) %>%
  left_join(NJtransitstations %>%
              select(STATION_ID,LATITUDE,LONGITUDE,geometry), by = "STATION_ID") %>%
  st_as_sf() %>%
  ggplot() +
  geom_sf(data = NJTransitLines) +
  geom_sf(aes(color = Mean_AbsError)) +
  geom_sf(data = NJshp, fill = "transparent") +
  labs(title = "To",
       x = "Predicted Mean Delay") +
  scale_color_gradient(low = "green",
                       high = "red") +
  theme(legend.position = "bottom") +
  mapTheme()


ggsave("Modeled_Delay_to_station.jpg", width = 9*.5, height = 16*.5, unit = "in", dpi = 300)

grid.arrange(C,B, ncol = 2, nrow=1,
             top = textGrob("Average of predicted Delay To and From Station", gp=gpar(fontsize=20,font=3)))
```

# Conclusions

It is apparent that this is a very accurate model. Overall the model predicts how late any given NJ transit train will be to a station with a `r paste0(round(mean(reg.cv$resample$Rsquared)*100,2),"%")` accuracy. Further, it predicts well for the commuter lines such as The Main Line, The Raritan Valley Line, and the Morristown Line. However, the fact that the model predicts well for all lines except the Atlantic City Line may indicate an issue with overfitting and the inability to generalize to different spatial contexts. With such a robust set of data, it is unlikely that we would see issues with predicting across the temporal axis though.   

Therefore, we recommend that NJ Transit make use of this tool for predicting when and where their trains will be late. In turn, this tool will then give operators the ability to work towards mitigation of the drivers of lateness in their system. This is a possible avenue for further expansion of this tool's capabilities. If we were given access to NJ Transit's mechanical issues data, provided that it exists, we could identify when and where mechanical issues cause lateness.   

It is clear that this is a powerful tool, not only for the transit operators, but also for the average NJ Transit rider. The ability to predict when a train will arrive with a margin of error of `r print(mae)` minutes could be highly attractive to the time-crunched transit rider. 

Regarding improvements to the model, in order to transition the model to an agency outside of NJ Transit, we could remove the line name and stop names as predictors and instead use the distance between each station. The idea being that if stations are relatively close to eachother, delays accumulate as trains cannot speed up to regain time. These changes could also be useful for the NJ Transit deployment as well. 

# Appendix / Citations

Freishtat, Sarah. “Waiting Longer for Follow Your Bus or Train? The CTA Has Been Running Fewer of Them during the Pandemic.,” 2021, 5.
Lazo, Luz. “Amtrak’s Chronic Delays Are Costing Millions of Dollars, Report Says,” n.d., 2.
Penney, Veronica. “How Coronavirus Has Changed New York City Transit, in One Chart,” 2021, 7.

